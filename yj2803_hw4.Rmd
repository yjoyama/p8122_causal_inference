---
title: "Homework 4"
author: "Yuki Joyama"
output: 
  pdf_document:
    latex_engine: xelatex
    extra_dependencies: ["fontspec", "amsmath", "amssymb", "unicode-math"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F)
```

```{r}
# libraries
library(tidyverse)
library(ggplot2)
library(dagitty)
library(tableone)
library(knitr)

# setup plot theme
theme_set(
  theme_bw() +
    theme(legend.position = "top")
  )
```


```{r}
# import data 
df = read_csv("./data/hw4_data.csv")
```

1. DAG
```{r}
g = dagitty('dag {
age [pos="-1.842,-0.039"]
black [pos="1.458,-0.317"]
educ [pos="-0.698,-0.114"]
hispan [pos="0.269,-0.760"]
married [pos="-2.461,-0.426"]
nodegree [pos="-1.567,-0.659"]
re74 [pos="-1.219,0.594"]
re75 [pos="0.011,0.971"]
re78 [outcome,pos="0.893,0.468"]
treat [exposure,pos="-2.558,0.500"]
age -> educ
age -> married
age -> re74
age -> re75
age -> re78
age -> treat
black -> educ
black -> nodegree
black -> re74
black -> re75
black -> re78
black -> treat
educ -> re74
educ -> re75
educ -> re78
educ -> treat
hispan -> educ
hispan -> nodegree
hispan -> re74
hispan -> re75
hispan -> re78
hispan -> treat
married -> treat
nodegree -> educ
nodegree -> re74
nodegree -> re75
nodegree -> re78
nodegree -> treat
re74 -> re75
re74 -> re78
re75 -> re78
treat -> re74
treat -> re75
treat -> re78
}')
plot(g)
```

Note of the variables in the DAG:  
`treat`: treatment assignment (job training); exposure  
- Suppose that the job training was completed before 1974, `treat` is likely to infludence `re74`, `re75` and `re78`  
`age`: age in years  
- `age` may affect `married`, `treat`, `educ` and all the income status (`re74`, `re75`, `re78`)    
`educ`: education in years   
- `educ` may affect all the income status and `treat`  
`black`, `hispan`: indicators for African American and hispanic  
- Both of the ethnicity indicator may affect all the income status, `nodegree`, `treat`, and `educ`  
`married`: indicator for married  
- `married` could influence `treat`  
`nodegree`: indicator for highschool degree  
- `nodegree` may affect `treat`, `educ`, and all the income status  
`re74`: income in 1974    
- `re74` can influence `re75` and `re78`  
`re75`: income in 1975  
- `re75` can influence `re78`  
`re78`: income in 1978; outcome    

Given the DAG, covariates that need to be adjusted in investigating the effect of exposure on the outcome are `nodegree`, `hispan`, `black`, `educ` and `age`.  

2. I will evaluate the covariate balance using standardized mean differences. 
```{r}
cov = c("nodegree", "hispan", "black", "educ", "age")

# construct a table
tab = CreateTableOne(vars = cov, strata = "treat", data = df, test = FALSE)
print(tab, smd = TRUE)
```
We can see that most covariates have SMD > 0.1 except for `educ`, indicating the potential imbalance between the two treatment group. 

3. Propensity score estimates are calculated by fitting a logistic regression. 
```{r}
# fit PS model
ps.fit <- glm(as.factor(treat) ~ as.factor(nodegree) + as.factor(hispan) + as.factor(black) + educ + age, family = "binomial", data = df)

ps.fit |> 
  broom::tidy() |> 
  kable()

# estimate PS
df.ps <- predict(ps.fit, type = 'response')
print(df.ps[1:50])
```
Listed values are the propensity scores for each observation in the dataset (only showing the first 50 observations out of 614).


